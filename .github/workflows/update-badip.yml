name: source

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays at midnight
  workflow_dispatch:

jobs:
  update-badip:
    name: Update Bad IP Lists
    runs-on: ubuntu-latest
    steps:
      - name: Generate token from GitHub App
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: 2510838
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.generate_token.outputs.token }}
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download latest bad IP list (keep scores)
        run: |
          curl -sS https://raw.githubusercontent.com/stamparm/ipsum/master/ipsum.txt \
            | grep -v '^#' \
            | grep -v -E '\s[1-2]$' \
            | awk '{print $1","$2}' \
            > badip_list.csv
      - name: Ingest RSS/Atom feeds for additional IPs
        run: |
          python scripts/ingest_feeds.py

      - name: Fetch additional public blocklists (local tester)
        run: |
          python scripts/fetch_blacklists.py

      - name: Fetch Hacker News cyber attack mentions by country
        run: |
          python scripts/hacker_news.py

      - name: Orchestrate merge and processing
        run: |
          # `process_badips.py` now ingests `data/*.csv` (including fetched outputs)
          # and is the single writer that updates `badip_list.csv` and `data/badips.db`.
          python scripts/process_badips.py

      - name: Show sample and count
        run: |
          echo "Saved to badip_list.csv"
          head -n 20 badip_list.csv || true
          echo "Total lines: $(wc -l < badip_list.csv)"

      - name: Generate visualizations and README
        run: |
          python scripts/generate_visualizations.py

      - name: Commit generated changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Update bad IP database and visualizations - $(date)" || echo "No changes to commit"

      - name: Push generated changes to main
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "Pushing generated changes to 'main'"
          if [ -z "${GH_TOKEN}" ]; then
            echo "GH_TOKEN not provided; cannot authenticate for push"; exit 1
          fi
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
          git push origin HEAD:main

      - name: Upload bad IP list artifact
        uses: actions/upload-artifact@v4
        with:
          name: badip-database
          path: |
            badip_list.csv
            data/badips.db
            data/

