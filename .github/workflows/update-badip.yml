name: source

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays at midnight
  workflow_dispatch:

jobs:
  update-badip:
    name: Update Bad IP Lists
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests geoip2 matplotlib pandas plotly kaleido feedparser

      - name: Download latest bad IP list (keep scores)
        run: |
          curl -sS https://raw.githubusercontent.com/stamparm/ipsum/master/ipsum.txt \
            | grep -v '^#' \
            | grep -v -E '\s[1-2]$' \
            | awk '{print $1","$2}' \
            > badip_list.csv

      - name: Ingest RSS/Atom feeds for additional IPs
        run: |
          python scripts/ingest_feeds.py

      # OTX ingestion removed per request

      - name: Show sample and count
        run: |
          echo "Saved to badip_list.csv"
          head -n 20 badip_list.csv || true
          echo "Total lines: $(wc -l < badip_list.csv)"

      - name: Process bad IPs and build database
        run: |
          python scripts/process_badips.py

      - name: Generate visualizations and README
        run: |
          python scripts/generate_visualizations.py

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Update bad IP database and visualizations - $(date)" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Upload bad IP list artifact
        uses: actions/upload-artifact@v4
        with:
          name: badip-database
          path: |
            badip_list.csv
            data/badips.db
            data/
